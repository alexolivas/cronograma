# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

orbs:
    coveralls: coveralls/coveralls@1.0.4
jobs:
    # runs not using Workflows must have a `build` job as entry point
    build:
        working_directory: ~/cronograma
        docker:
            - image: circleci/node:10.16.3 # ...with this image as the primary container; this is where all `steps` will run
            - image: mongo:4.2.0 # and this image as the secondary service container
        steps:
            - checkout
            - run:
                name: update-npm
                command: 'sudo npm install -g npm@latest'
            - restore_cache: # special step to restore the dependency cache
                # Read about caching dependencies: https://circleci.com/docs/2.0/caching/
                key: dependency-cache-{{ checksum "package-lock.json" }}
            - run:
                name: install-npm-wee
                command: npm install
            - save_cache: # special step to save the dependency cache
                key: dependency-cache-{{ checksum "package-lock.json" }}
                paths:
                    - ./node_modules

            # run linter
            - run:
                name: lint
                command: npm run lint

            # run tests and coveralls coverage report
            - run:
                name: "Run Jest and Collect Coverage Reports"
                command: npm run test-coverage
            - coveralls/upload